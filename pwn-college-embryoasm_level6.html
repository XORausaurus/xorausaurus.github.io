<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>EmbryoASM Level 6 - Exploitation Freaks</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Exploitation</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwntools-debugging.html"><strong aria-hidden="true">2.1.</strong> Pwntools Debugging</a></li><li class="chapter-item expanded "><a href="cve-2015-3887.html"><strong aria-hidden="true">2.2.</strong> CVE-2015-3887</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> Cyber Santa is Coming to Town</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="hackthebox-pwn-snowy.html"><strong aria-hidden="true">2.3.1.</strong> Mr Snowy</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-sleigh.html"><strong aria-hidden="true">2.3.2.</strong> Sleigh</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-naughty-list.html"><strong aria-hidden="true">2.3.3.</strong> Naughty List</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.4.</strong> ROPEmporium</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="ropemporium-split.html"><strong aria-hidden="true">2.4.1.</strong> Split</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Reverse Engineering</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="anatomy-of-a-gopher.html"><strong aria-hidden="true">3.1.</strong> Anatomy of a Gopher</a></li><li class="chapter-item expanded "><a href="gomalware-reversing-in-action.html"><strong aria-hidden="true">3.2.</strong> Go Malware Reverse Engineering with Kaspersky</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Arizona State University Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwn-college-embryoasm_level6.html" class="active"><strong aria-hidden="true">3.3.1.</strong> EmbryoASM Level 6</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell_level1.html"><strong aria-hidden="true">3.3.2.</strong> BabyShell Level 1</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level3.html"><strong aria-hidden="true">3.3.3.</strong> BabyShell Level 3</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level4.html"><strong aria-hidden="true">3.3.4.</strong> BabyShell Level 4</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level5.html"><strong aria-hidden="true">3.3.5.</strong> BabyShell Level 5</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level6.html"><strong aria-hidden="true">3.3.6.</strong> BabyShell Level 6</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Flare 8 (2021)</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="credchecker.html"><strong aria-hidden="true">3.4.1.</strong> credchecker</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Programming</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> The Linux Programming Interface</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="programming-tee.html"><strong aria-hidden="true">4.1.1.</strong> Exercise 4.1 (reproducing the tee linux binary)</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Other</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="half-handshake-crack.html"><strong aria-hidden="true">5.1.</strong> Half-Handshake Crack</a></li><li class="chapter-item expanded "><a href="tn-wn722n-monitor-mode.html"><strong aria-hidden="true">5.2.</strong> TN-WN722N Monitor Mode</a></li><li class="chapter-item expanded "><a href="awus036ach-monitor-mode.html"><strong aria-hidden="true">5.3.</strong> AWUS036ACH Monitor Mode</a></li><li class="chapter-item expanded "><a href="rpi-rtl88x2bu-evil-AP.html"><strong aria-hidden="true">5.4.</strong> RTL88x2bu Fake Access Point</a></li><li class="chapter-item expanded "><a href="windows-cheatsheet.html"><strong aria-hidden="true">5.5.</strong> Windows Cheatsheet</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Exploitation Freaks</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="embryoasm-level-6"><a class="header" href="#embryoasm-level-6">EmbryoASM Level 6</a></h1>
<p>So this challenge is a little bit harder since we need to compute the modulo of rdi with 256 and rsi with 65536 using only
MOV instructions.</p>
<p>Since i am nowhere near being a shifting, rotating and masking or mathematic wizard, i was struggling at the beginning of this challenge. But thanks to Kanak on discord, he showed us on video a little more how we were supposed to complete the challenge and everything start making sense for me.</p>
<h2 id="how-it-works"><a class="header" href="#how-it-works">How it works</a></h2>
<p>Basically the program asks us to modulo with 256 and 65536, note that :</p>
<pre><code>- 4 is the biggest value 2 bits can address.
- 16 is the biggest value 4 bits can address.
- 256 is the biggest value 8 bits can address.
- 65536 is the biggest value 16 bits can address.
</code></pre>
<p>When we talk about modulo, we always think about division and the remainder of it.</p>
<p>But there's something special about modulo with 4, 16, 256, 65536,... :</p>
<pre><code>- When we do modulo with 4 we're basically asking for the last 2 bits of that number (Square root of 4).
- When we do modulo with 16 we're basically asking for the last 4 bits of that number (Square root of 16).
- When we do modulo with 256 we're basically asking for only the last 8 bits of that number (Square root of 256).
- When we modulo with 65536 we're basically asking for only the last 16 bits of that number (Square root of 65536).
</code></pre>
<p>Examples:</p>
<pre><code>   9382 % 4 = 2         &lt;= Here we access the last 2 bits
   9382 % 16 = 6       &lt;= Here we access the last 4 bits
   9382 % 256 = 166     &lt;= Here we access the last 8 bits
   9382 % 65536 = 9382  &lt;= Here we access the last 16 bits
</code></pre>
<pre><code>  2019249 % 4 = 1        &lt;= Here we access the last 2 bits
  2019249 % 16 = 1      &lt;= Here we access the last 4 bits
  2019249 % 256 = 177    &lt;= Here we access the last 8 bits
  2019249 % 65536 = 53169 &lt;= Here we access the last 16 bits
</code></pre>
<pre><code>  0x12345678 % 4 = 0
  0x12345678 % 16 = 0x8
  0x12345678 % 256 = 0x78
  0x12345678 % 65536 = 0x5678
  0x12345678 % 4294967296 = 0x12345678

  It is sometimes easier to see the pattern using hexadecimal characters.
</code></pre>
<p>But since we can't use division on the challenge we need to know how to compute modulo a different way...</p>
<p>After a bit of research i stumbled across this post on stackoverflow where someone was asking different ways to modulo a certain value, i read that these operations are the same :</p>
<pre><code>    9382 % 4 = 2
    9382 &amp; (4 - 1) = 2        &lt;= Same as the precedent operation

    9382 % 16 = 6
    9382 &amp; (16 - 1) = 6       &lt;= Same as the precedent operation

    9382 % 256 = 166
    9382 &amp; (256 - 1) = 166    &lt;= Same as the precedent operation

    9382 % 65536 = 9382
    9382 &amp; (65536 - 1) = 9382 &lt;= Same as the precedent operation
</code></pre>
<pre><code>    0x12345678 % 16 = 0x8
    0x12345678 &amp; (16 - 1) = 0x8

    0x12345678 % 256 = 0x78
    0x12345678 &amp; (256 - 1) = 0x78
    
    0x12345678 % 65536 = 0x5678
    0x12345678 &amp; (65536 - 1) = 0x5678

    0x12345678 % 4294967296 = 0x12345678
    0x12345678 &amp; (4294967296 - 1) = 0x12345678
</code></pre>
<p>What we're doing is basically <em>masking</em> a number by <strong>AND'ing</strong> with (2 ** n bits we want to access - 1) and this does the same result as doing modulo on (2 ** n bits we want to access).</p>
<p>Let's put this in practice and complete the challenge</p>
<h2 id="solving-the-challenge"><a class="header" href="#solving-the-challenge">Solving the Challenge</a></h2>
<p>Okay so completing the challenge was pretty simple, we are asked to do the following :</p>
<pre><code>Welcome to EmbryoASMLevel6
==================================================
To interact with any level you will send raw bytes over stdin to this program.
To efficiently solve these problems, first run it once to see what you need,
then craft, assemble, and pipe your bytes to this program.

In this level you will be working with registers. You will be asked to modify
or read from registers_use.

We will now set some values in memory dynamically before each run. On each run
the values will change. This means you will need to do some type of formulaic
operation with registers_use. We will tell you which registers_use are set beforehand
and where you should put the result. In most cases, its rax.

Another cool concept in x86 is the independent access to lower register bytes.
Each register in x86 is 64 bits in size, in the previous levels we have accessed
the full register using rax, rdi or rsi. We can also access the lower bytes of
each register using different register names. For example the lower
32 bits of rax can be accessed using eax, lower 16 bits using ax,
lower 8 bits using al, etc.
MSB                                    LSB
+----------------------------------------+
|                   rax                  |
+--------------------+-------------------+
                     |        eax        |
                     +---------+---------+
                               |   ax    |
                               +----+----+
                               | ah | al |
                               +----+----+
Lower register bytes access is applicable to all registers_use.

Using only the following instruction(s):
mov
Please compute the following:
rax = rdi modulo 256
rbx = rsi module 65536

We will now set the following in preparation for your code:
rdi = 0x57c5
rsi = 0x4fe709fc


Please give me your assembly in bytes (up to 0x1000 bytes):
</code></pre>
<p>Note that on x64 you can access the lower 8 bits of rsi and rdi, using sil and dil, respectively. </p>
<p>This mean we can complete this challenge using only the mov instruction as asked.</p>
<pre><code class="language-x86asm">.global _start
.intel_syntax noprefix
_start:
    mov rax, 0      ; zero out rax
    mov al, dil     ; take the last 8 bits of rdi into last 8 bits of rax
    mov rbx, 0      ; zero out rbx
    mov bx, si      ; take the last 16 bits of rsi into last 16 bits of rbx
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="gomalware-reversing-in-action.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="pwn-college-babyshell_level1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="gomalware-reversing-in-action.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="pwn-college-babyshell_level1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
